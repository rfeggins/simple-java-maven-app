pipeline {
    agent any

    environment {
      Integer buildSuccessTransition = 5
      Integer buildFailTransition = 1
      jiraSite = "Hertz-Jira"  // Hertz site
      ddtl_ID =  "ddtl-5304"
      jiraComment = "No Comment"
      gitCommitMsg = "No Message"

      //initializing a local variable
      in_progress = "https://hertzdigital.atlassian.net/rest/api/2/status/11408"
      dev_complete = "https://hertzdigital.atlassian.net/rest/api/2/status/11419"
      ready_to_deploy = "https://hertzdigital.atlassian.net/rest/api/2/status/6"
      to_do = "https://hertzdigital.atlassian.net/rest/api/2/status/11300"


    }  // End of Environment block

    stages {
        stage ('Validate Jira') {
          steps {
            script {
              def comment
              def issue
               // validate that ddtl number is found within Git Commit message
               if (ddtl_ID == "") {
                 echo "NO Commit msg found within Git Commit message Error 120"
                 echo "##########################"

                 comment = "${BUILD_URL} FAILED - ${ERROR}"

                 currentBuild.result = 'FAILURE'
                 exit 120

               } else {
                 echo "Following DDTL IDs retrieved from git commit message"
                 echo ddtl_ID
               }

                 // retrieving jira issue
              try {
                   issue = jiraGetIssue idOrKey: ddtl_ID, site: jiraSite


                   if ( issue.data.toString() == "" ) {
                         echo "The following Jira Issues are not found in" jiraSite ddtl_ID
                         echo "ERROR  message Error 130"
                         echo "##########################"
                         comment = "${BUILD_URL} FAILED - ${ERROR}"
                         currentBuild.result = 'FAILURE'
                         exit 130
                   } else {
                     echo issue.data.toString()
                   }

              } catch (ERROR) {
                   echo "The following Jira Issues are not found in" jiraSite ddtl_ID
                   echo "ERROR  message Error 130"
                   echo "##########################"
                   comment = "${BUILD_URL} FAILED - ${ERROR}"
                   currentBuild.result = 'FAILURE'
                   exit 130
              }  // End of Try block
            }  // End of script block
        }} // End of Validate Jira stage and Step



        stage('Build') {
            steps {
                sh 'mvn -v'
                echo "Build package"

                // if Build success then
                script {

                  try {
                          jiraAddComment idOrKey: ddtl_ID, comment: comment, site: jiraSite
                          def transitionInput = [ transition: [ name: buildSuccessTransition ] ]
                          jiraTransitionIssue idOrKey: ddtl_ID, input: transitionInput, site: jiraSite

                     } catch (error) {
                          def comment = "${BUILD_URL} FAILED - ${ERROR}"
                          jiraAddComment idOrKey: ddtl_ID, comment: comment, site: jiraSite
                          currentBuild.result = 'FAILURE'
                    }

                }


        }} //End of Build Stage

        stage('Test') {
            steps {
                sh 'mvn test'
        }} // End of Test Stage
        stage('Deploy to Dev') {
            steps {
                echo "Deploy to Dev"
                sh 'ls -l'
        }}
}}
/*
        stage('Update Jira Stage'){
           steps {
             script {
               echo "Update Jira Stage"

             } // End script
           }} // End Step // End Update Jira Stage

             echo "Update Jira "


    } // End Stages
} // End Pipeline
*/
